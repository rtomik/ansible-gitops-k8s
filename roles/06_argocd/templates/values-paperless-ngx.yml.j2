paperless-ngx:
  ## Image settings
  image:
    repository: ghcr.io/paperless-ngx/paperless-ngx
    tag: "2.19.2"
    pullPolicy: IfNotPresent
    
  ingress:
    enabled: true
    className: "traefik"
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
    hosts:
      - host: paperless.{{domain}}
        paths:
          - path: /
            pathType: Prefix
    tls:
      - hosts:
          - paperless.{{domain}}

  persistence:
    # Paperless data directory (search index, classification model, etc.)
    data:
      enabled: true
      storageClass: "longhorn"
      accessMode: ReadWriteOnce
      size: 1Gi
    # Paperless media directory (documents and thumbnails)
    media:
      enabled: true
      storageClass: "longhorn"
      accessMode: ReadWriteOnce
      size: 10Gi
    # Export directory (for exporting documents)
    export:
      enabled: true
      storageClass: "longhorn"
      accessMode: ReadWriteOnce
      size: 1Gi
    # Consume directory (for importing documents)
    consume:
      enabled: true
      storageClass: "longhorn"
      accessMode: ReadWriteOnce
      size: 5Gi

  postgresql:
    # External PostgreSQL connection details
    external:
      enabled: true
      host: "postgres-cluster-pooler.dbs.svc.cluster.local"
      port: 5432
      database: "paperless"
      username: "paperless"
      # Use existingSecret for credentials
      existingSecret: "paperless-db-credentials"
      passwordKey: "password"

  redis:
    external:
      enabled: true
      host: "dragonfly-cluster.dbs.svc.cluster.local"
      port: 6379
      database: 0
      username: "default"
      password: "{{ vault_dragonfly_password }}"

  config:
    url: https://paperless.tomik.lat
    allowedHosts: "*"

{% if deploy_authentik %}
  env:
    - name: PAPERLESS_APPS
      value: "allauth.socialaccount.providers.openid_connect"
    - name: PAPERLESS_AUTO_CREATE
      value: "true"
    - name: PAPERLESS_AUTO_LOGIN
      value: "true"
    - name: PAPERLESS_SOCIALACCOUNT_ALLOW_SIGNUPS
      value: "true"
    - name: PAPERLESS_ENABLE_ALLAUTH
      value: "true"      
    - name: PAPERLESS_LOGOUT_REDIRECT_URL
      value: "https://authentik.{{ domain }}/application/o/paperless-ngx/end-session/"  
    - name: PAPERLESS_SOCIALACCOUNT_PROVIDERS
      value: |
        {
          "openid_connect": {
            "APPS": [
              {
                "provider_id": "authentik",
                "name": "Authentik",
                "client_id": "$(authentik_client_id)",
                "secret": "$(authentik_client_secret)",
                "settings": {
                  "server_url": "https://authentik.{{ domain }}/application/o/paperless-ngx/.well-known/openid-configuration"
                }
              }
            ],
            "OAUTH_PKCE_ENABLED": "True"
          }
        }

  extraEnvFrom:
    - secretRef:
        name: paperless-authentik-credentials
{% endif %}
