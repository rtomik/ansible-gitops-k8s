# default values https://github.com/jellyfin/jellyfin-helm/blob/master/charts/jellyfin/values.yaml
jellyfin:
  ingress:
    enabled: true
    className: traefik
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
    hosts:
      - host: jellyfin.{{ domain }}
        paths:
          - path: /
            pathType: Prefix
    tls:
      - hosts:
          - jellyfin.{{ domain }}


  livenessProbe:
    initialDelaySeconds: 15
    tcpSocket:
      port: http
      successThreshold: 1
      failureThreshold: 10
      timeoutSeconds: 5
      periodSeconds: 15

  readinessProbe:
    initialDelaySeconds: 15
    tcpSocket:
      port: http
      successThreshold: 1
      failureThreshold: 10
      timeoutSeconds: 10
      periodSeconds: 15

  podSecurityContext:
{% if jellyfin_hw.enabled %}
    fsGroup: 104  # Changed from 0 to 104 for video group access
{% else %}
    fsGroup: 0
{% endif %}
  
  securityContext:
{% if jellyfin_hw.enabled %}
    privileged: true  # Required for hardware acceleration
    runAsUser: 0
    runAsGroup: 0
{% else %}
    runAsUser: 0
    runAsGroup: 0
{% endif %}

{% if jellyfin_hw.enabled %}
# Hardware acceleration volumes and mounts
  volumes:
    - name: jellyfin-hardware
      hostPath:
        path: {{ jellyfin_hw.path }}

  volumeMounts:
    - name: jellyfin-hardware
      mountPath: {{ jellyfin_hw.path }}

{% if jellyfin_hw.scheduling_enabled | default(true) %}
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
{% if jellyfin_hw.nodes is defined %}
{% for node in jellyfin_hw.nodes %}
            - {{ node }}
{% endfor %}
{% elif jellyfin_hw.node is defined %}
            - {{ jellyfin_hw.node }}
{% else %}
            - master-01
{% endif %}
{% endif %}
{% endif %}

  persistence:
    config:
      enabled: true
      mountPath: /config
      storageClass: longhorn
      accessMode: ReadWriteOnce
      size: 1Gi
{% if external_storage.enabled and external_storage.applications.qbittorrent.enabled %} 
    media:
      enabled: true
      type: pvc
      existingClaim: "{{ external_storage.applications.qbittorrent.pvc_name }}"
{% endif %}