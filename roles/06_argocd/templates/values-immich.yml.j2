---
immich:
  image:
    tag: v1.119.0

  # Disable embedded PostgreSQL - using centralized database
  postgresql:
    enabled: false

  immich:
    metrics:
      enabled: true
    persistence:
      library:
        existingClaim: immich-library

  env:
    # Use centralized PostgreSQL database
    DB_HOSTNAME: "{{ postgresql.cluster_name }}-pooler.{{ postgresql.namespace }}.svc.cluster.local"
    DB_USERNAME:
      valueFrom:
        secretKeyRef:
          name: immich-db-credentials
          key: username
    DB_DATABASE_NAME:
      valueFrom:
        secretKeyRef:
          name: immich-db-credentials
          key: database
    DB_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: immich-db-credentials
          key: password
    # Set additional required environment variables explicitly
    REDIS_HOSTNAME: '{% raw %}{{ printf "%s-redis-master" .Release.Name }}{% endraw %}'
    IMMICH_MACHINE_LEARNING_URL: '{% raw %}{{ printf "http://%s-machine-learning:3003" .Release.Name }}{% endraw %}'

  redis:
    enabled: true
    architecture: standalone
    auth:
      enabled: false

  server:
    enabled: true
    image:
      repository: ghcr.io/immich-app/immich-server
      pullPolicy: IfNotPresent
    # Add health check configuration for better startup handling
    probes:
      startup:
        enabled: true
        spec:
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 60
      liveness:
        enabled: true
        spec:
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 5
      readiness:
        enabled: true
        spec:
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 5
    ingress:
      main:
        enabled: true
        className: traefik
        annotations:
          traefik.ingress.kubernetes.io/router.entrypoints: websecure
          traefik.ingress.kubernetes.io/router.middlewares: default-default-headers@kubernetescrd
        hosts:
          - host: immich.{{ domain }}
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - immich.{{ domain }}

  machine-learning:
    enabled: true
    image:
      repository: ghcr.io/immich-app/immich-machine-learning
      pullPolicy: IfNotPresent
    env:
      TRANSFORMERS_CACHE: /cache
    persistence:
      cache:
        enabled: true
        size: 5Gi
        # Optional: Set this to pvc to avoid downloading the ML models every start.
        type: emptyDir
        accessMode: ReadWriteMany
        storageClass: longhorn
